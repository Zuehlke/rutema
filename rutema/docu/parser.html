<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="author" content="Vassilis Rizopoulos" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF8" />
  <link rel="stylesheet" href="style.css" type="text/css" />
  <title>Implementing a Rutema parser</title>
</head>
<body>
  <div id="page" align="center">
    <div id="content" style="width:800px">
      <div id="logo">
        <div style="margin-top:70px" class="whitetitle">rutema</div>
      </div>
      <div id="topheader">
        <div align="left" class="bodytext">
          <br />
        </div>
      </div>
      <div id="menu">
      </div>
      <div id="submenu">
        <div align="right" class="smallgraytext" style="padding:9px;">
          <a href="../index.html">patir</a> | <a href="index.html">rutema</a> | <a href="rdoc/index.html">rdoc</a>
        </div>
      </div>
      <div id="contenttext">
        <div style="padding:10px">
          <span class="titletext">Implementing a Rutema parser</span>
        </div>
        <div class="bodytext" style="padding:12px;" align="justify">
					Version>=0.6.0
          <h2>How to implement a parser</h2>
          <p>
          In this example we will walk through implementing a parser that extends the capabilities of Rutema::MinimalXMLParser and in the process show you how easy it is.<br/>
          <h3>Adding a step</h3>
          Lets add a &lt;compare> element to our little testing DSL that will fail if two parameters differ.<br/> 
          We want the element in the specification to be in the form
          </p><p>&lt;compare param1="" param2=""/></p>
          <p>
             In order to "execute" a step, the parser needs to assign a command to it.<br/>
              <a href="http://patir.rubyforge.org/">patir</a> offers a <a href="rdoc/classes/Patir/Command.html">Command abstraction</a> that is used by rutema for this purpose.<br/>
              There are two concrete implementations of it, ShellCommand (which executes commands in a shell) and RubyCommand which wraps ruby code in the Command abstraction. For details check the patir documentation.
      </p><p>
      For this example lets just add a bit of ruby as our command:        
  <pre>
require 'rutema/system'

class SampleParser < Rutema::MinimalXMLParser
  def element_compare step
    #create the command and assign it to the step
    step.cmd=Patir::RubyCommand.new("compare") do |cmd|
      #the command success is set by the return value of the block
      cmd.output=""
      if step.param1==step.param2
        :success
      else
        cmd.error="Things don't match"
        :error
      end
     end
  end
end
</pre>
Now whenever the parser encounters a <em>compare</em> element it will assign the command and it will be executed when passed to the runner.
</p>
<p>
Ofcourse the above code has several holes. Always validate the step contents before doing anything:
<pre>
unless step.has_param1? &amp;&amp; step.has_param2?
  raise ParserError,"Missing one of param1/param2 attributes"
end
</pre>
You can verify the existence of any attribute by using step.has_attribute_name? - always a good idea! <br/>
Errors during parsing should throw a ParserException as above.<br/>
Also a good idea is to rescue all exceptions within a RubyCommand and set the cmd.error attribute accordingly.
    </p>
    <h3>Using the parser</h3>
    <p>
      Assuming you saved your brand new parser in my_brand_new_parser.rb, you use it by replacing the configuration.parser directove with something like the following:
<pre>
  require 'my_brand_new_parser'
  configuration.parser={:class=>SampleParser}
</pre>
Remember, rutema configuration files are valid ruby code!
    </p>
        </div>
      </div>
        <div id="leftpanel">
          <div align="justify" class="graypanel">
            <span class="bodytext">Home</span><br />
            <a href="index.html" class="smallgraytext">More...</a><br /><br />
            <span class="bodytext">Documentation</span><br />
            <a href="docu.html" class="smallgraytext">More...</a><br /><br />
          </div>
        </div>
      <div id="footer" class="smallgraytext">
        <a href="index.html">Home</a> | <a href="../contact.html">Contact</a> | &copy; 2007 Vassilis Rizopoulos</a> 
      </div>
    </div>
  </div>
</body>
</html>